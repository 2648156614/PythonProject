{% extends "base.html" %}

{% block title %}ç»Ÿè®¡ä¿¡æ¯{% endblock %}

{% block content %}
<div class="container">
    <h2 class="my-4">ğŸ“Š ç­”é¢˜ç»Ÿè®¡é¢æ¿</h2>

    <!-- é”™è¯¯æç¤º -->
    {% if error %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> {{ error }}
    </div>
    {% endif %}

    <!-- æ€»ä½“ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                æ­£ç¡®ç‡</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ accuracy }}%</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-trophy-fill fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                æ€»ç­”é¢˜æ•°</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-clipboard-data fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                æ­£ç¡®ç­”é¢˜</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ correct_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-check-circle-fill fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                å¹³å‡ç”¨æ—¶</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ avg_time }}ç§’</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-clock-fill fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if total_count > 0 %}
    <!-- åœ†å½¢åŒ…è£¹å¯è§†åŒ– -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow h-100">
                <div class="card-header bg-purple text-white" style="background: linear-gradient(120deg, #6f42c1, #8e2de2);">
                    <h6 class="mb-0"><i class="bi bi-bullseye"></i> é¢˜å‹æ€»è§ˆï¼ˆç¼©æ”¾æŸ¥çœ‹ç»†èŠ‚ï¼‰</h6>
                </div>
                <div class="card-body">
                    <div class="circle-pack-container" id="circlePack"></div>
                    <p class="text-muted small text-center mb-0">æ‚¬åœæŸ¥çœ‹æç¤ºï¼Œç‚¹å‡»åœ†åœˆå¯æ”¾å¤§æŸ¥çœ‹è¯¥é¢˜å‹çš„æ­£ç¡®ç‡ä¸ç”¨æ—¶ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="row">
        <!-- æ­£ç¡®ç‡ç¯å½¢å›¾ -->
        <div class="col-xl-4 col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-primary text-white">
                    <h6><i class="bi bi-pie-chart-fill"></i> æ­£ç¡®ç‡åˆ†å¸ƒ</h6>
                </div>
                <div class="card-body">
                    <canvas id="accuracyChart" width="300" height="300"></canvas>
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            æ€»ç­”é¢˜æ•°: {{ total_count }} | æ­£ç¡®: {{ correct_count }} | é”™è¯¯: {{ total_count - correct_count }}
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- å„é¢˜ç›®æ­£ç¡®ç‡æŸ±çŠ¶å›¾ -->
        <div class="col-xl-8 col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-success text-white">
                    <h6><i class="bi bi-bar-chart-fill"></i> å„é¢˜ç›®æ­£ç¡®ç‡å¯¹æ¯”</h6>
                </div>
                <div class="card-body">
                    <canvas id="problemAccuracyChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¬¬äºŒè¡Œå›¾è¡¨ -->
    <div class="row">
        <!-- ç­”é¢˜æ—¶é—´è¶‹åŠ¿å›¾ -->
        <div class="col-xl-12 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-info text-white">
                    <h6><i class="bi bi-graph-up"></i> æœ€è¿‘ç­”é¢˜æ—¶é—´è¶‹åŠ¿</h6>
                </div>
                <div class="card-body">
                    <canvas id="timeTrendChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
    <div class="card shadow mt-4">
        <div class="card-header bg-dark text-white">
            <h5><i class="bi bi-table"></i> è¯¦ç»†ç»Ÿè®¡è¡¨æ ¼</h5>
        </div>
        <div class="card-body">
            {% if problem_stats %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="thead-light">
                        <tr>
                            <th>é¢˜ç›®ç±»å‹</th>
                            <th>ç­”é¢˜æ¬¡æ•°</th>
                            <th>æ­£ç¡®æ¬¡æ•°</th>
                            <th>æ­£ç¡®ç‡</th>
                            <th>å¹³å‡ç”¨æ—¶</th>
                            <th>å­¦ä¹ çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in problem_stats %}
                        <tr>
                            <td><strong>{{ stat.template_name }}</strong></td>
                            <td>
                                <span class="badge badge-primary badge-pill">{{ stat.total }}</span>
                            </td>
                            <td>
                                <span class="badge badge-success badge-pill">{{ stat.correct }}</span>
                            </td>
                            <td>
                                {% if stat.total > 0 %}
                                    {% set progress = (stat.correct/stat.total*100) %}
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1" style="height: 20px;">
                                            <div class="progress-bar {% if progress >= 80 %}bg-success{% elif progress >= 60 %}bg-info{% elif progress >= 40 %}bg-warning{% else %}bg-danger{% endif %}"
                                                 role="progressbar" style="width: {{ progress }}%">
                                                {{ "%.1f"|format(progress) }}%
                                            </div>
                                        </div>
                                        <small class="text-muted ml-2">{{ "%.1f"|format(progress) }}%</small>
                                    </div>
                                {% else %}
                                    <span class="text-muted">æš‚æ— æ•°æ®</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge badge-secondary badge-pill">{{ stat.avg_time|round(1) }}ç§’</span>
                            </td>
                            <td>
                                {% if stat.total > 0 %}
                                    {% set progress = (stat.correct/stat.total*100) %}
                                    {% if progress >= 80 %}
                                        <span class="badge badge-success"><i class="bi bi-star-fill"></i> ä¼˜ç§€</span>
                                    {% elif progress >= 60 %}
                                        <span class="badge badge-info"><i class="bi bi-check-circle"></i> è‰¯å¥½</span>
                                    {% elif progress >= 40 %}
                                        <span class="badge badge-warning"><i class="bi bi-exclamation-circle"></i> ä¸€èˆ¬</span>
                                    {% else %}
                                        <span class="badge badge-danger"><i class="bi bi-lightbulb"></i> éœ€æ”¹è¿›</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge badge-secondary"><i class="bi bi-clock"></i> æœªå¼€å§‹</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">æš‚æ— é¢˜ç›®ç»Ÿè®¡æ•°æ®</h5>
            </div>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <!-- å›¾è¡¨JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // å¯ç¼©æ”¾åœ†å½¢åŒ…è£¹å›¾
        const circleData = {
            name: 'é¢˜ç›®è¦†ç›–',
            children: (
                {{ problem_stats|tojson|safe }} || []
            ).map(stat => ({
                name: stat.template_name || 'æœªå‘½åé¢˜å‹',
                value: Math.max(stat.total, 1),
                total: stat.total,
                correct: stat.correct,
                accuracy: stat.total > 0 ? +(stat.correct / stat.total * 100).toFixed(1) : 0,
                avg_time: +(stat.avg_time || 0).toFixed(1)
            }))
        };

        const packWidth = document.getElementById('circlePack').clientWidth || 960;
        const packHeight = 520;

        const color = d3.scaleLinear()
            .domain([0, 5])
            .range(["#e0d7ff", "#6f42c1"]);

        const root = d3.pack()
            .size([packWidth, packHeight])
            .padding(8)(
                d3.hierarchy(circleData)
                    .sum(d => d.value)
                    .sort((a, b) => b.value - a.value)
            );

        let focus = root;
        let view;

        const svg = d3.select('#circlePack')
            .append('svg')
            .attr('viewBox', `-${packWidth / 2} -${packHeight / 2} ${packWidth} ${packHeight}`)
            .style('display', 'block')
            .style('width', '100%')
            .style('height', `${packHeight}px`)
            .style('cursor', 'pointer')
            .style('background', 'radial-gradient(circle at 30% 30%, #faf5ff, #f2ecff)');

        const tooltip = d3.select('#circlePack')
            .append('div')
            .attr('class', 'circle-pack-tooltip')
            .style('opacity', 0);

        const nodes = svg.append('g')
            .selectAll('circle')
            .data(root.descendants())
            .join('circle')
            .attr('fill', d => d.depth === 0 ? 'transparent' : color(d.depth))
            .attr('stroke', d => d.depth === 1 ? '#6f42c1' : '#fff')
            .attr('stroke-width', 2)
            .on('mouseover', function(event, d) {
                if (d === root) return;
                d3.select(this).transition().duration(150).attr('stroke-width', 3);
                tooltip.transition().duration(150).style('opacity', 1);
                tooltip.html(`
                    <strong>${d.data.name}</strong><br/>
                    ç­”é¢˜æ¬¡æ•°ï¼š${d.data.total} æ¬¡<br/>
                    æ­£ç¡®ç‡ï¼š${d.data.accuracy}%<br/>
                    å¹³å‡ç”¨æ—¶ï¼š${d.data.avg_time} ç§’
                `)
                .style('left', `${event.offsetX + 10}px`)
                .style('top', `${event.offsetY + 10}px`);
            })
            .on('mouseout', function() {
                d3.select(this).transition().duration(150).attr('stroke-width', 2);
                tooltip.transition().duration(200).style('opacity', 0);
            })
            .on('click', (event, d) => focus !== d && zoom(event, d));

        const labels = svg.append('g')
            .style('font', '14px sans-serif')
            .attr('fill', '#44337a')
            .attr('pointer-events', 'none')
            .attr('text-anchor', 'middle')
            .selectAll('text')
            .data(root.descendants())
            .join('text')
            .style('fill-opacity', d => d.parent === root ? 1 : 0)
            .style('display', d => d.parent === root ? 'inline' : 'none')
            .text(d => d.data.name);

        zoomTo([root.x, root.y, root.r * 2]);

        function zoomTo(v) {
            const k = packWidth / v[2];
            view = v;
            labels.attr('transform', d => `translate(${(d.x - v[0]) * k}, ${(d.y - v[1]) * k})`);
            nodes.attr('transform', d => `translate(${(d.x - v[0]) * k}, ${(d.y - v[1]) * k})`);
            nodes.attr('r', d => d.r * k);
        }

        function zoom(event, d) {
            focus = d;
            const transition = svg.transition()
                .duration(event.altKey ? 2000 : 750)
                .tween('zoom', () => {
                    const i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2]);
                    return t => zoomTo(i(t));
                });

            labels
                .filter(function(node) { return node.parent === focus || this.style.display === 'inline'; })
                .transition(transition)
                .style('fill-opacity', node => node.parent === focus ? 1 : 0)
                .on('start', function(node) { if (node.parent === focus) this.style.display = 'inline'; })
                .on('end', function(node) { if (node.parent !== focus) this.style.display = 'none'; });
        }

        // æ­£ç¡®ç‡ç¯å½¢å›¾
        const accuracyCtx = document.getElementById('accuracyChart').getContext('2d');
        const accuracyChart = new Chart(accuracyCtx, {
            type: 'doughnut',
            data: {
                labels: ['æ­£ç¡®', 'é”™è¯¯'],
                datasets: [{
                    data: [{{ correct_count }}, {{ total_count - correct_count }}],
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 3,
                    borderColor: '#fff',
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((context.raw / total) * 100);
                                return `${context.label}: ${context.raw}æ¬¡ (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        // å„é¢˜ç›®æ­£ç¡®ç‡æŸ±çŠ¶å›¾
        const problemCtx = document.getElementById('problemAccuracyChart').getContext('2d');

        // æ‰‹åŠ¨æ„å»ºæ•°æ®ï¼Œé¿å…JSONåºåˆ—åŒ–é—®é¢˜
        const problemNames = [
            {% for stat in problem_stats %}
            '{{ stat.template_name }}'{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        const accuracyData = [
            {% for stat in problem_stats %}
            {% if stat.total > 0 %}
            {{ (stat.correct/stat.total*100)|round(1) }}
            {% else %}
            0
            {% endif %}
            {% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        const problemStats = [
            {% for stat in problem_stats %}
            {
                total: {{ stat.total }},
                correct: {{ stat.correct }},
                avg_time: {{ stat.avg_time|round(1) }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        const problemChart = new Chart(problemCtx, {
            type: 'bar',
            data: {
                labels: problemNames,
                datasets: [{
                    label: 'æ­£ç¡®ç‡ (%)',
                    data: accuracyData,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                    ],
                    borderColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                    ],
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'æ­£ç¡®ç‡ (%)'
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const index = context.dataIndex;
                                if (problemStats && problemStats[index]) {
                                    const stat = problemStats[index];
                                    return `ç­”é¢˜: ${stat.total}æ¬¡ | æ­£ç¡®: ${stat.correct}æ¬¡ | å¹³å‡ç”¨æ—¶: ${stat.avg_time}ç§’`;
                                }
                                return '';
                            }
                        }
                    }
                }
            }
        });

        // ç­”é¢˜æ—¶é—´è¶‹åŠ¿å›¾
        const timeCtx = document.getElementById('timeTrendChart').getContext('2d');

        // æ¨¡æ‹Ÿæ—¶é—´æ•°æ® - åœ¨å®é™…åº”ç”¨ä¸­å¯ä»¥ä»æ•°æ®åº“è·å–çœŸå®æ•°æ®
        const timeData = [45, 38, 42, 35, 40, 32, 28, 31, 29, 27];
        const timeLabels = timeData.map((_, index) => `ç¬¬${index + 1}æ¬¡`);

        const timeChart = new Chart(timeCtx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'ç­”é¢˜æ—¶é—´ (ç§’)',
                    data: timeData,
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#17a2b8',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'æ—¶é—´ (ç§’)'
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'nearest'
                }
            }
        });
    });
    </script>
    {% else %}
    <!-- æ²¡æœ‰æ•°æ®æ—¶çš„æ˜¾ç¤º -->
    <div class="card shadow">
        <div class="card-body text-center py-5">
            <i class="bi bi-graph-up fa-4x text-muted mb-3"></i>
            <h3 class="text-muted">æš‚æ— ç­”é¢˜æ•°æ®</h3>
            <p class="text-muted mb-4">æ‚¨è¿˜æ²¡æœ‰å¼€å§‹ç­”é¢˜ï¼Œç»Ÿè®¡æ•°æ®å°†åœ¨æ‚¨ç­”é¢˜åæ˜¾ç¤º</p>
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary btn-lg">
                <i class="bi bi-play-circle"></i> å¼€å§‹ç­”é¢˜
            </a>
        </div>
    </div>
    {% endif %}
</div>

<style>
.card {
    border: none;
    border-radius: 15px;
    transition: transform 0.2s;
}
.card:hover {
    transform: translateY(-2px);
}
.card-header {
    border-radius: 15px 15px 0 0 !important;
    font-weight: 600;
}
.progress {
    border-radius: 10px;
    background-color: #f8f9fa;
}
.border-left-primary {
    border-left: 4px solid #4e73df !important;
}
.border-left-success {
    border-left: 4px solid #1cc88a !important;
}
.border-left-info {
    border-left: 4px solid #36b9cc !important;
}
.border-left-warning {
    border-left: 4px solid #f6c23e !important;
}
.badge-pill {
    border-radius: 50rem;
    padding: 0.35em 0.65em;
}
.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}
</style>
{% endblock %}